
    <!-- Global properties -->
    <property name="cactus.conf.weblogic6x" value="${cactus.conf.dir}/weblogic6x"/>
    <property name="cactus.target.weblogic6x" value="${cactus.target.dir}/weblogic6x"/>

    <!-- Location of WebLogic server directory. Can be overriden by calling
         scripts -->
    <property name="cactus.weblogic6x.server" 
        value="${cactus.home.weblogic6x}/wlserver6.1"/>

	<!-- Allow additional libraries to be added -->
	<property name="cactus.weblogic6x.libpath" value=""/>
	
    <!--
       ========================================================================
         Run WebLogic 6.x tests
       ========================================================================
    -->
    <target name="cactus.run.weblogic6x" 
        depends="cactus.init,cactus.setup.weblogic6x,cactus.war,cactus.deploy.weblogic6x"
        if="cactus.home.weblogic6x" description="Run tests on WebLogic 6.x">

        <!-- Start the servlet engine, wait for it to be started, run the
             unit tests, stop the servlet engine, wait for it to be stopped.
             The servlet engine is stopped if the tests fail for any reason -->

        <antcall target="cactus.runservertests.weblogic6x" inheritRefs="true"/>

    </target>

    <target name="cactus.runservertests.weblogic6x" depends="cactus.runservertests.task.weblogic6x, cactus.runservertests.target.weblogic6x"/>

    <target name="cactus.runservertests.task.weblogic6x" if ="cactus.test.task">

        <taskdef name="cactus.testTask" classname="${cactus.test.task}"/>
        <runservertests
            testURL="http://localhost:${cactus.port}/${cactus.context}/ServletRedirector?Cactus_Service=RUN_TEST"
            startTarget="cactus.start.weblogic6x"
            stopTarget="cactus.stop.weblogic6x">
          <test>
          	<cactus.testTask/>
          </test>
        </runservertests>

    </target>

    <target name="cactus.runservertests.target.weblogic6x" unless="cactus.test.task">

        <runservertests
            testURL="http://localhost:${cactus.port}/${cactus.context}/ServletRedirector?Cactus_Service=RUN_TEST"
            startTarget="cactus.start.weblogic6x"
            stopTarget="cactus.stop.weblogic6x"
            testTarget="cactus.test"/>

    </target>

    <!--
       ========================================================================
         Start WebLogic 6.x
       ========================================================================
    -->
    <target name="cactus.start.weblogic6x" description="Start WebLogic 6.x"
        depends="cactus.check.weblogic6x" if="cactus.home.weblogic6x">

        <available property="cactus.jdk1.4+" 
            classname="java.lang.CharSequence"/>
        <fail if="cactus.jdk1.4+">Our script does not yet support running 
WL 6.x under JDK 1.4+. Please submit a patch!</fail>

        <property name="cactus.weblogic6x.java.library.path"
            location="${java.library.path}:${cactus.weblogic6x.libpath}:${cactus.weblogic6x.server}/bin"/>

        <java jvm="${cactus.jvm}" classname="weblogic.Server" fork="yes"
            dir="${cactus.target.weblogic6x}">

            <jvmarg value="-hotspot"/>
            <jvmarg value="-ms64m"/>
            <jvmarg value="-mx64m"/>

            <sysproperty key="java.library.path" path="${cactus.weblogic6x.java.library.path}"/>
            <sysproperty key="weblogic.RootDirectory" value="."/>
            <sysproperty key="weblogic.Domain" value="testdomain"/>
            <sysproperty key="weblogic.Name" value="testserver"/>
            <sysproperty key="bea.home" file="${cactus.home.weblogic6x}"/>
            <sysproperty key="weblogic.management.password" value="password"/>
            <sysproperty key="java.security.policy" value="=./lib/weblogic.policy"/>

            <classpath>
                <pathelement location="${cactus.weblogic6x.server}/lib/weblogic_sp.jar"/>
                <pathelement location="${cactus.weblogic6x.server}/lib/weblogic.jar"/>
            </classpath>

        </java>

    </target>

    <!--
       ========================================================================
         Stop WebLogic 6.x
       ========================================================================
    -->
    <target name="cactus.stop.weblogic6x" description="Stop WebLogic 6.x"
        depends="cactus.check.weblogic6x" if="cactus.home.weblogic6x">

        <java jvm="${cactus.jvm}" classname="weblogic.Admin" fork="yes">

            <classpath>
                <pathelement location="${cactus.weblogic6x.server}/lib/weblogic_sp.jar"/>
                <pathelement location="${cactus.weblogic6x.server}/lib/weblogic.jar"/>
            </classpath>

            <arg line="-url t3://localhost:${cactus.port}"/>
            <arg line="-username system"/>
            <arg line="-password password"/>
            <arg value="SHUTDOWN"/>

        </java>

    </target>

    <!--
       ========================================================================
         Display a warning message if the needed servlet engine home property
         is not set
       ========================================================================
    -->
    <target name="cactus.check.weblogic6x" unless="cactus.home.weblogic6x">

        <echo></echo>
        <echo>******************************************************</echo>
        <echo>WARNING : The 'cactus.home.weblogic6x' property has not</echo>
        <echo>been set. No test will be run on that servlet engine.</echo>
        <echo>******************************************************</echo>
        <echo></echo>

    </target>

    <!--
       ========================================================================
         Deploy the cactified webapp
       ========================================================================
    -->
    <target name="cactus.deploy.weblogic6x" if="cactus.home.weblogic6x" 
        description="Deploy the webapp on WebLogic 6.x">

        <!-- Copy the webapp -->
        <mkdir dir="${cactus.target.weblogic6x}/tmp/${cactus.context}"/>
        <copy todir="${cactus.target.weblogic6x}/tmp/${cactus.context}">
            <fileset dir="${cactus.target.dir}/${cactus.context}"/>
        </copy>

        <!-- Add the WebLogic specific descriptors -->
        <copy todir="${cactus.target.weblogic6x}/tmp/${cactus.context}/WEB-INF">
            <fileset dir="${cactus.conf.weblogic6x}">
                <include name="weblogic.xml"/>
            </fileset>
        </copy>

        <jar destfile="${cactus.target.weblogic6x}/config/testdomain/applications/${cactus.context}.war">
            <fileset dir="${cactus.target.weblogic6x}/tmp/${cactus.context}"/>
        </jar>

    </target>

    <!--
       ========================================================================
         Set up a valid WebLogic 6.x directory structure in the
         cactus.target.weblogic6x directory.
       ========================================================================
    -->
    <target name="cactus.setup.weblogic6x"
        depends="cactus.init, cactus.check.weblogic6x" if="cactus.home.weblogic6x"
        description="Set up a WebLogic 6.x directory structure">

        <mkdir dir="${cactus.target.weblogic6x}/config/testdomain/applications"/>

        <!-- Copy WL 6.x configuration files -->
        <copy file="${cactus.conf.weblogic6x}/config.xml"
            todir="${cactus.target.weblogic6x}/config/testdomain" filtering="on"/>
        <copy file="${cactus.conf.weblogic6x}/fileRealm.properties"
            todir="${cactus.target.weblogic6x}/config/testdomain"/>
        <copy file="${cactus.conf.weblogic6x}/SerializedSystemIni.dat"
            todir="${cactus.target.weblogic6x}/config/testdomain"/>

    </target>

    <!--
       ========================================================================
         Clean generated files (including distributables)
       ========================================================================
    -->
    <target name="cactus.clean.weblogic6x" depends="cactus.init, cactus.clean"
        description="Clean target directory">
        <delete includeEmptyDirs="true">
            <fileset dir="${cactus.target.weblogic6x}"/>
        </delete>
    </target>
