    <!-- 
       ========================================================================
         Run JBoss 3.x tests
       ========================================================================
    -->
    <target name="test.jboss.3x" depends="prepare.test.jboss.3x"
        if="jboss.home.3x" description="Run tests on JBoss 3.x">

        <!-- Start the container, wait for it to be started, run the
             unit tests, stop the container, wait for it to be stopped.
             The container is stopped if the tests fail for any reason -->

        <runservertests
            testURL="http://localhost:${test.port}/test/ServletRedirector?Cactus_Service=RUN_TEST"
            startTarget="start.jboss.3x"
            stopTarget="stop.jboss.3x"
            testTarget="test"/>

    </target>

    <!-- 
       ========================================================================
         Start JBoss 3.x
       ========================================================================
    -->
    <target name="start.jboss.3x">

        <java classname="org.jboss.Main" fork="yes">

            <jvmarg value="-Dprogram.name=${jboss.home.3x}/bin/run.bat"/>
            <jvmarg value="-Djboss.server.home.dir=${target.jboss3x.dir}/server/cactus"/>
            <jvmarg value="-Djboss.server.home.url=file://${basedir}/${target.jboss3x.dir}/server/cactus"/>
            
            <arg line="-c cactus"/>
            
            <classpath>
                <pathelement location="${jboss.home.3x}/bin/run.jar"/>
				<pathelement path="${java.home}/../lib/tools.jar"/>
                <!--fileset dir="${jboss.home.3x}/lib">
                    <include name="*.jar"/>
                </fileset-->
            </classpath>

        </java>

    </target>

    <!-- 
       ========================================================================
         Stop JBoss 3.x
       ========================================================================
    -->
    <target name="stop.jboss.3x">

        <java classname="org.jboss.Shutdown" fork="yes">

            <arg value="localhost"/>
            <arg value="8080"/>
            
            <classpath>
                <pathelement location="${jboss.home.3x}/bin/shutdown.jar"/>
            </classpath>

        </java>

    </target>

    <!-- 
       ========================================================================
         Display a warning message if the needed container home property
         is not set
       ========================================================================
    -->
    <target name="check.test.jboss.3x" unless="jboss.home.3x">

        <echo message=""/>
        <echo message="******************************************************"/>
        <echo message="WARNING : The 'jboss.home.3x' property has not been "/>
        <echo message="set. No test will be run on that container."/>
        <echo message="******************************************************"/>
        <echo message=""/>

    </target>

    <!-- 
       ========================================================================
         Prepare directories and variables for running the tests
       ========================================================================
    -->
    <target name="prepare.test.jboss.3x"
        depends="check.test.jboss.3x,testwar" if="jboss.home.3x">

        <echo message="jboss.home.3x = ${jboss.home.3x}"/>

        <property name="target.jboss3x.dir" value="${target.test.dir}/jboss3x"/>
        <property name="conf.jboss3x.dir" value="${conf.test.dir}/jboss3x"/>

        <!-- Create a server configuration using the minimal JBoss 
             configuration and adding the JBossWeb Service -->
        <copy todir="${target.jboss3x.dir}/server/cactus">
            <fileset dir="${jboss.home.3x}/server/minimal"/>
            <!--fileset dir="${jboss.home.3x}/server/default"/-->
        </copy>

        <copy todir="${target.jboss3x.dir}/server/cactus/deploy/jbossweb.sar">
            <fileset dir="${jboss.home.3x}/server/default/deploy/jbossweb.sar"/>
        </copy>
        <copy todir="${target.jboss3x.dir}/server/cactus/lib">
            <fileset dir="${jboss.home.3x}/server/default/lib">
                <include name="javax.servlet.jar"/>
                <include name="jboss.jar"/>
            </fileset>
        </copy>

        <!-- Create the war file -->
        <copy file="${target.test.dir}/test.war"
            tofile="${target.jboss3x.dir}/server/cactus/deploy/test.war"/>

        <!-- Update the war to include the proprietary jboss-web.xml and
             *.properties config files. -->

        <!-- Hack: Make sure jboss-web.xml is always newer than the war so that
             the later is always updated. Waiting for an Ant bug fix -->
        <touch file="${target.jboss3x.dir}/server/cactus/deploy/test.war"
            datetime="06/28/2000 2:02 pm"/>

        <war update="true"
            warfile="${target.jboss3x.dir}/server/cactus/deploy/test.war">

            <!--webinf dir="${conf.jboss3x.dir}">
                <include name="jboss-web.xml"/>
            </webinf-->
            <classes dir="${conf.jboss3x.dir}">
                <include name="*.properties"/>
            </classes>
        </war>

    </target>
