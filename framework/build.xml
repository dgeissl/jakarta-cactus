<?xml version="1.0"?>

<!--
  =============================================================================
    Build file for the Cactus framework.

    The following Ant tasks need to be available in your ant installation (i.e.
    the Ant task themselves and their dependent jars need to be put in
    ANT_HOME/lib) :

        checkstyle             [OPTIONAL] Only needed for the "checkstyle"
                                          target which is used to check coding
                                          and naming conventions.

        ajc/ajdoc              [REQUIRED] AspectJ Ant tasks

    The following properties need to be set in either a ./build.properties or
    a ${user.home}/build.properties one or in a calling Ant script :

        j2ee.jar               [REQUIRED] The location of the J2EE API jar.
                               Depending on the version (1.2 or 1.3) of it, the
                               corresponding Cactus Framework will be built. For
                               example if you use J2EE 1.3 jar, then the Cactus
                               jar will contain the Filter Redirector which is
                               only available for Servlet 2.3 (part of J2EE
                               1.3).

        log4j.jar              [REQUIRED] The location of the Log4j jar.

        commons.httpclient.jar [REQUIRED] The location of the Commons
                               Httpclient jar.

        httpunit.jar           [REQUIRED] The location of the HttpUnit jar.

    This script should be started with the following command line :

        ant <target>

    Run "ant -projecthelp" to get a list of available targets. The default
    target is "dist"
  =============================================================================
-->
<project name="Cactus Framework" default="dist" basedir=".">

    <!-- Give user a chance to override without editing this file
         (and without typing -D each time it compiles it) -->
    <property file="build.properties" />
    <property file="${user.home}/build.properties" />

    <!-- Global project properties -->
    <property name="project.name.text" value="Cactus Framework"/>
    <property name="project.name.file" value="cactus"/>
    <property name="project.version" value="1.3dev"/>

    <!-- Prefix to add to all distributable files -->
    <property name="project.prefix" value="jakarta-"/>

    <!--
       ========================================================================
         Default values for properties not defined in build.properties or in
         a higher level calling Ant script
       ========================================================================
    -->
    <property name="year" value="2000-2002"/>
    <property name="debug" value="on"/>
    <property name="optimize" value="off"/>
    <property name="deprecation" value="off"/>

    <!--
       ========================================================================
         Set the properties related to the source tree.
         Note: These properties are defined in a target as some need the
               j2ee.api property to be set
       ========================================================================
    -->
    <target name="properties.source">

        <!-- Source locations for the build -->
        <property name="src.dir" value="src"/>
        <property name="src.java.dir" value="${src.dir}/java"/>
        <property name="src.java.share.dir" value="${src.java.dir}/share"/>
        <property name="src.java.specific.dir"
            value="${src.java.dir}/j2ee${j2ee.api}"/>
        <property name="src.test.dir" value="${src.dir}/test"/>
        <property name="src.test.share.dir" value="${src.test.dir}/share"/>
        <property name="build.dir" value="."/>
        <property name="conf.dir" value="conf"/>
        <property name="web.dir" value="web"/>

    </target>

    <!--
       ========================================================================
         Set the properties related to the target area
       ========================================================================
    -->
    <!-- Destination locations for the build -->
    <property name="target.dir" value="target"/>
    <property name="target.classes.dir" value="${target.dir}/classes"/>
    <property name="target.classes.java.dir"
        value="${target.classes.dir}/java"/>
    <property name="target.classes.test.dir"
        value="${target.classes.dir}/test"/>
    <property name="target.conf.dir" value="${target.dir}/conf"/>
    <property name="target.doc.dir" value="${target.dir}/doc"/>
    <property name="target.doc.api.dir" value="${target.doc.dir}/api"/>

    <!-- Distribution directory, i.e. where the expanded distibutable files
         are located -->
    <property name="dist.dir" value="dist"/>
    <property name="dist.lib.dir" value="${dist.dir}/lib"/>
    <property name="dist.doc.dir" value="${dist.dir}/doc"/>
    <property name="dist.doc.api.dir" value="${dist.doc.dir}/api"/>
    <property name="dist.web.dir" value="${dist.dir}/web"/>

    <!-- Release directory, i.e. where the zipped distribution is located -->
    <property name="release.dir" value="release"/>

    <!--
       ========================================================================
        Names of deliverables
        Note: These properties are defined in a target as some need the
              j2ee.api property to be set
       ========================================================================
    -->
    <target name="properties.deliverables">

        <!-- The custom task jar and helper classes -->
        <property name="framework.jar.name"
            value="${project.name.file}-${j2ee.api}"/>

    </target>

    <!--
       ========================================================================
         Useful patterns for targets
       ========================================================================
    -->
    <path id="project.class.path">

        <pathelement location="${j2ee.jar}"/>
        <pathelement location="${log4j.jar}"/>
        <pathelement location="${commons.httpclient.jar}"/>
        <pathelement location="${httpunit.jar}"/>

        <!-- Includes system classpath for jars that are in ANT_HOME/lib such
             as aspectrt.jar, etc -->
        <pathelement path="${java.class.path}"/>
    </path>

    <!--
       ========================================================================
         Verify that all mandatory properties have been set
       ========================================================================
    -->
    <target name="check.properties">

        <condition property="properties.ok">
            <and>
                <available file="${j2ee.jar}"/>
                <available file="${log4j.jar}"/>
                <available file="${commons.httpclient.jar}"/>
                <available file="${httpunit.jar}"/>
           </and>
        </condition>

        <fail message="Missing property or property pointing to an invalid file (check your build.properties file)"
            unless="properties.ok"/>

    </target>

    <!--
       ========================================================================
         Find out if we're using J2EE
       ========================================================================
    -->
    <target name="check.j2ee.version">

        <condition property="j2ee.api" value="13">
            <available classname="javax.servlet.Filter"
                classpathref="project.class.path"/>
        </condition>

        <condition property="j2ee.api" value="12">
            <available classname="javax.servlet.Servlet"
                classpathref="project.class.path"/>
        </condition>

        <fail message="Unsupported J2EE version" unless="j2ee.api"/>

    </target>

    <!--
       ========================================================================
         Initialize the build. Must be called by all targets
       ========================================================================
    -->
    <target name="init"
        depends="check.properties,check.j2ee.version,properties.source,properties.deliverables">

        <tstamp/>

        <echo message="----- ${project.name.text} ${project.version} -----"/>
        <echo message=""/>
        <echo message="java.class.path = ${java.class.path}"/>
        <echo message=""/>
        <echo message="java.home = ${java.home}"/>
        <echo message="user.home = ${user.home}"/>
        <echo message="ant.home = ${ant.home}"/>
        <echo message=""/>
        <echo message="j2ee.jar = ${j2ee.jar}"/>
        <echo message="  => j2ee.api = ${j2ee.api}"/>
        <echo message=""/>

        <!-- Filters -->
        <filter token="version" value="${project.version}"/>
        <filter token="year" value="${year}"/>
        <filter token="today" value="${TODAY}"/>
        <filter token="project.name.text" value="${project.name.text}"/>
        <filter token="project.name.file" value="${project.name.file}"/>

        <!-- AspectJ task definition -->
        <taskdef name="ajc" classname="org.aspectj.tools.ant.taskdefs.Ajc"/>
        <taskdef name="ajdoc" classname="org.aspectj.tools.ant.taskdefs.Ajdoc"/>

    </target>

    <!--
       ========================================================================
         Compiles the sources
       ========================================================================
    -->
    <target name="compile" depends="init" description="Compile the sources">

        <mkdir dir="${target.classes.java.dir}"/>
        <mkdir dir="${target.classes.test.dir}"/>

        <ajc destdir="${target.classes.java.dir}"
          deprecation="${deprecation}" optimize="${optimize}">

            <src path="${src.java.share.dir}"/>
            <src path="${src.java.specific.dir}"/>

            <exclude name="**/package.html"/>
            <exclude name="**/overview.html"/>

            <classpath refid="project.class.path"/>
        </ajc>

        <javac destdir="${target.classes.test.dir}"
          deprecation="${deprecation}" optimize="${optimize}">

            <src path="${src.test.share.dir}"/>

            <classpath>
                <path path="${target.classes.java.dir}"/>
                <path refid="project.class.path"/>
            </classpath>

        </javac>

    </target>

    <!--
       ========================================================================
         Create the runtime jar file
       ========================================================================
    -->
    <target name="jar" depends="compile" description="Generate the library jar">

        <mkdir dir="${target.conf.dir}"/>

        <!-- Copy the manifest in order to replace the version token filter -->
        <copy todir="${target.conf.dir}" file="${conf.dir}/manifest"
            filtering="on"/>

        <jar destfile="${target.dir}/${framework.jar.name}.jar"
          manifest="${target.conf.dir}/manifest">
            <fileset dir="${target.classes.java.dir}"/>
        </jar>

    </target>

    <!--
       ========================================================================
         Generate the documentation (javadoc)
       ========================================================================
    -->
    <target name="doc" depends="init" description="Generates the documentation">

        <mkdir dir="${target.doc.api.dir}"/>

        <ajdoc
            packagenames="org.apache.cactus.*"
            destdir="${target.doc.api.dir}"
            author="true"
            public="true"
            version="true"
            use="true"
            windowtitle="${project.name.text} ${project.version}"
            doctitle="${project.name.text} ${project.version}"
            bottom="Copyright &amp;copy; ${year} Apache Software Foundation. All Rights Reserved.">

            <sourcepath>
                <pathelement location="${src.java.share.dir}"/>
                <pathelement location="${src.java.specific.dir}"/>
            </sourcepath>

            <classpath refid="project.class.path"/>

        </ajdoc>

    </target>

    <!--
       ========================================================================
         Generate the distributable files
       ========================================================================
    -->
    <target name="dist" depends="jar,doc"
        description="Generate the distributable files">

        <mkdir dir="${dist.lib.dir}"/>
        <mkdir dir="${dist.doc.api.dir}"/>
        <mkdir dir="${dist.web.dir}"/>

        <copy todir="${dist.lib.dir}"
            file="${target.dir}/${framework.jar.name}.jar"/>
        <copy todir="${dist.doc.api.dir}">
            <fileset dir="${target.doc.api.dir}"/>
        </copy>
        <copy todir="${dist.web.dir}">
            <fileset dir="${web.dir}"/>
        </copy>

    </target>

    <!--
       ========================================================================
         Common script for both "release" and "nightly" targets. Must only be
         called by "release" or "nightly" target as it needs the following
         properties defined before calling it :

             anttasks.release.name

       ========================================================================
    -->
    <target name="release.common" depends="clean,dist">

        <mkdir dir="${release.dir}"/>

        <zip destfile="${release.dir}/${framework.release.name}.zip">
            <fileset dir="${dist.dir}"/>
        </zip>

    </target>

    <!--
       ========================================================================
         Generate a full release (i.e. the zipped release file)
       ========================================================================
    -->
    <target name="release.prepare" depends="init">

        <!-- For a release, the suffix is the version -->
        <property name="project.suffix" value="-${project.version}"/>

        <!-- Name of full release -->
        <property name="framework.release.name"
            value="${project.prefix}${framework.jar.name}${project.suffix}"/>

    </target>

    <target name="release" depends="release.prepare,release.common"
        description="Generate the release">
    </target>

    <!--
       ========================================================================
         Generate a nightly release (i.e. the zipped release file)
       ========================================================================
    -->
    <target name="nightly.prepare" depends="init">

        <!-- Sets the date for the release prefix : YYYYMMDD -->
        <tstamp/>

        <!-- Suffix to add to all distributable files -->
        <property name="project.suffix" value="-${DSTAMP}"/>

        <!-- Name of nightly release -->
        <property name="framework.release.name"
            value="${project.prefix}${framework.jar.name}${project.suffix}"/>

    </target>

    <target name="nightly" depends="nightly.prepare,release.common"
        description="Generate the release">
    </target>

    <!--
       ========================================================================
         Clean generated files (including distributables)
       ========================================================================
    -->
    <target name="clean" depends="init" description="Clean all generated files">

        <delete dir="${target.dir}"/>
        <delete dir="${dist.dir}"/>
        <delete dir="${release.dir}"/>

    </target>

    <!--
       ========================================================================
         Perform a code audit using CheckStyle.
       ========================================================================
    -->
    <target name="checkstyle" depends="init"
        description="Perform a code audit using Checkstyle">

        <taskdef name="checkstyle"
            classname="com.puppycrawl.tools.checkstyle.CheckStyleTask"/>

        <mkdir dir="${target.dir}"/>

        <echo message="Errors are reported in ${target.dir}/checkstyle_errors.xml"/>

        <checkstyle paramPattern="^(the|is|has)[A-Z][a-zA-Z0-9]*$"
            allowProtected="true" headerFile="LICENSE">

            <fileset dir="${src.java.dir}">
                <include name="**/*.java"/>
                <exclude name="**/*Aspect.java"/>
            </fileset>
            <fileset dir="${src.test.dir}">
                <include name="**/*.java"/>
            </fileset>
            <formatter type="xml" toFile="${target.dir}/checkstyle_errors.xml"/>
        </checkstyle>

    </target>

</project>
