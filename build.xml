<?xml version="1.0"?>

<!--
  =============================================================================
    Master build file for building all Cactus components (the Ant tasks,
    the framework itself, the documentation, the samples).

    See build.properties.sample for details of mandatory and optional
    properties to set.

    This script should be started with the following command line :

        ant <target>

    Run "ant -projecthelp" to get a list of available targets. The default
    target is "dist"
  =============================================================================
-->
<project name="Master Cactus Build" default="dist" basedir=".">

    <!-- Give user a chance to override without editing this file
         (and without typing -D each time it compiles it) -->
    <property file="build.properties" />
    <property file="${user.home}/build.properties" />

    <!-- Global project properties -->
    <property name="project.name.text" value="Cactus"/>
    <property name="project.name.file" value="cactus"/>
    <property name="project.version" value="1.5dev"/>

    <!-- Prefix to add to all distributable files -->
    <property name="project.prefix" value="jakarta-"/>

    <property name="year" value="2000-2002"/>
    <property name="debug" value="on"/>
    <property name="optimize" value="off"/>
    <property name="deprecation" value="off"/>

    <!--
       ========================================================================
         Set the properties related to the target tree
         Note: These properties are defined in a target as some need the
               j2ee.api property to be set
       ========================================================================
    -->
    <target name="properties.target">

        <property name="target.dir" value="target-${j2ee.api}"/>
        <property name="target.lib.dir" value="${target.dir}/lib"/>

    </target>

    <!--
       ========================================================================
         Set the properties related to the distribution tree
         Note: These properties are defined in a target as some need the
               j2ee.api property to be set
       ========================================================================
    -->
    <target name="properties.distribution">

        <property name="dist.dir" value="dist-${j2ee.api}"/>
        <property name="dist.lib.dir" value="${dist.dir}/lib"/>
        <property name="dist.doc.dir" value="${dist.dir}/doc"/>
        <property name="dist.doc.api.dir" value="${dist.doc.dir}/api"/>
        <property name="dist.web.dir" value="${dist.dir}/web"/>
        <property name="dist.sample.servlet.dir"
            value="${dist.dir}/sample-servlet"/>

    </target>

    <!-- Release directory, i.e. where the zipped distribution is located -->
    <property name="release.dir" value="release"/>

    <!--
       ========================================================================
         Display configurable properties values
       ========================================================================
    -->
    <target name="display.properties">

        <echo message="----- ${project.name.text} ${project.version} -----"/>
        <echo message=""/>
        <echo message="java.class.path = ${java.class.path}"/>
        <echo message=""/>
        <echo message="java.home = ${java.home}"/>
        <echo message="user.home = ${user.home}"/>
        <echo message="ant.home = ${ant.home}"/>
        <echo message=""/>
        <echo message="commons.logging.jar = ${commons.logging.jar}"/>
        <echo message="commons.httpclient.jar = ${commons.httpclient.jar}"/>
        <echo message="httpunit.jar = ${httpunit.jar}"/>
        <echo message="junit.jar = ${junit.jar}"/>
        <echo message="aspectjrt.jar = ${aspectjrt.jar}"/>
        <echo message="log4j.jar = ${log4j.jar}"/>
        <echo message="jstl.jar = ${jstl.jar}"/>
        <echo message="standard.jar = ${standard.jar}"/>
        <echo message=""/>
        <echo message="j2ee.jar = ${j2ee.jar}"/>
        <echo message="servlet.jar = ${servlet.jar}"/>
        <echo message=""/>
        <echo message="cvs.executable = ${cvs.executable}"/>
        <echo message="stylebook.jar = ${stylebook.jar}"/>
        <echo message=""/>
        <echo message="clover.enable (optional) = ${clover.enable}"/>
        <echo message=""/>

    </target>

    <!--
       ========================================================================
         Verify that all mandatory properties have been set
       ========================================================================
    -->
    <target name="check.properties">

        <condition property="properties.ok">
            <and>
                <available file="${servlet.jar}"/>
                <available file="${j2ee.jar}"/>
                <available file="${log4j.jar}"/>
                <available file="${commons.logging.jar}"/>
                <available file="${commons.httpclient.jar}"/>
                <available file="${httpunit.jar}"/>
                <available file="${junit.jar}"/>
                <available file="${aspectjrt.jar}"/>
                <available file="${jstl.jar}"/>
                <available file="${standard.jar}"/>
                <isset property="cvs.executable"/>
           </and>
        </condition>

        <fail message="Missing property or property pointing to an invalid file (check your build.properties file)"
            unless="properties.ok"/>

    </target>

    <!--
       ========================================================================
         Find out the J2EE API version
       ========================================================================
    -->
    <target name="check.j2ee.version">

        <condition property="j2ee.api" value="13">
            <available classname="javax.servlet.Filter"
                classpath="${j2ee.jar}"/>
        </condition>

        <condition property="j2ee.api" value="12">
            <available classname="javax.servlet.Servlet"
                classpath="${j2ee.jar}"/>
        </condition>

        <fail message="Unsupported J2EE version" unless="j2ee.api"/>

        <echo message="j2ee.api = ${j2ee.api}"/>

    </target>

    <!--
       ========================================================================
         Load all dynamic properties
       ========================================================================
    -->
    <target name="load.properties"
        depends="check.j2ee.version,properties.target,properties.distribution"/>

    <!--
       ========================================================================
         Initialize the build. Must be called by all targets
       ========================================================================
    -->
    <target name="init"
        depends="display.properties,check.properties,load.properties">

        <tstamp/>

    </target>

    <!--
       ========================================================================
          Generate the distributable files
       ========================================================================
    -->

    <!-- Run Cactus Ant tasks dist target -->
    <target name="run.anttasks" depends="init">

        <ant target="dist" antfile="anttasks/build.xml"
            inheritAll="false">

            <property file="build.properties" />
            <property file="${user.home}/build.properties" />

        </ant>

    </target>

    <!-- Run Cactus Framework dist target -->
    <target name="run.framework" depends="init, run.anttasks">

        <ant target="dist" antfile="framework/build.xml"
            inheritAll="false">

            <!-- j2ee.jar property is needed here as it is overriden in the
                 build-admin.xml and we need to propagate it -->
            <property name="j2ee.jar" value="${j2ee.jar}"/>
            <property file="build.properties"/>
            <property file="${user.home}/build.properties"/>

        </ant>

    </target>

    <!-- Run Cactus Servlet Sample dist target -->
    <target name="run.sample-servlet" depends="run.anttasks,run.framework">

         <ant target="dist" antfile="sample-servlet/build.xml"
            inheritAll="false">

             <!-- j2ee.jar property is needed here as it is overriden in the
                  build-admin.xml and we need to propagate it -->
            <property name="j2ee.jar" value="${j2ee.jar}"/>
            <property file="build.properties"/>
            <property file="${user.home}/build.properties"/>

        </ant>

    </target>

    <!-- Run Documentation dist target -->
    <target name="run.documentation" depends="run.anttasks">

        <ant target="dist" antfile="documentation/build.xml"
            inheritAll="false">

            <property file="build.properties" />
            <property file="${user.home}/build.properties" />

        </ant>

    </target>

    <!-- Generate clover report -->
    <target name="run.clover" depends="run.framework,run.sample-servlet"
        if="clover.enable">

        <!-- Clover will read this file to generate the report -->
        <property name="clover.initstring"
            location="${target.dir}/clover-coverage.db"/>
        <echo message="clover.initstring = ${clover.initstring}"/>

        <java classname="com.cortexeb.tools.clover.reporters.html.HtmlReporter">

            <arg value="--outputdir"/>
            <arg path="${dist.doc.dir}/clover-${j2ee.api}"/>
            <arg value="--showSrc"/>
            <arg value="--initstring"/>
            <arg path="${clover.initstring}"/>
            <arg value="--title"/>
            <arg value="'Cactus ${project.version} for J2EE API ${j2ee.api}'"/>

        </java>

    </target>

    <!-- Run the dist target of all dependent projects -->
    <target name="run"
        depends="run.anttasks,run.framework,run.sample-servlet,run.documentation,run.clover">
    </target>

    <!--
       ========================================================================
          Package all generated distributables from all subprojects into the
          main distribution area.
       ========================================================================
     -->
    <target name="package.anttasks" depends="init">

        <!-- Rename the jars to suffix them with the version number -->
        <mkdir dir="${dist.lib.dir}"/>
        <copy tofile="${dist.lib.dir}/cactus-ant-${project.version}.jar"
            file="anttasks/dist/lib/cactus-ant.jar"/>

    </target>

    <target name="package.framework" depends="init">

        <!-- Rename the jars to suffix them with the version number -->
        <mkdir dir="${dist.lib.dir}"/>
        <copy tofile="${dist.lib.dir}/cactus-${project.version}.jar"
            file="framework/dist-${j2ee.api}/lib/cactus.jar"/>

        <mkdir dir="${dist.web.dir}"/>
        <copy todir="${dist.web.dir}">
            <fileset dir="framework/dist-${j2ee.api}/web"/>
        </copy>

    </target>

    <target name="package.sample-servlet" depends="init">

        <mkdir dir="${dist.sample.servlet.dir}"/>
        <unzip src="sample-servlet/dist-${j2ee.api}/bin/sample-servlet.zip"
            dest="${dist.sample.servlet.dir}"/>

    </target>

    <target name="package.documentation.clover.yes" if="clover.enable">

        <mkdir dir="${dist.doc.dir}"/>
        <copy tofile="${dist.doc.dir}/coverage.html"
            file="documentation/dist/doc/coverage_${j2ee.api}.html"/>

    </target>

    <target name="package.documentation.clover.no" unless="clover.enable">

        <mkdir dir="${dist.doc.dir}"/>
        <copy tofile="${dist.doc.dir}/coverage.html"
            file="documentation/dist/doc/coverage_empty.html"/>

    </target>

    <target name="package.documentation"
        depends="init,package.documentation.clover.yes,package.documentation.clover.no">

        <mkdir dir="${dist.doc.dir}"/>
        <copy todir="${dist.doc.dir}">
            <fileset dir="documentation/dist/doc">
                <exclude name="**/javadoc*.html"/>
                <exclude name="**/coverage*.html"/>
            </fileset>
        </copy>
        <copy tofile="${dist.doc.dir}/javadoc.html"
            file="documentation/dist/doc/javadoc_${j2ee.api}.html"/>

        <!-- copy javadoc -->
        <copy todir="${dist.doc.api.dir}/anttasks">
            <fileset dir="anttasks/dist/doc/api"/>
        </copy>
        <copy todir="${dist.doc.api.dir}/framework-${j2ee.api}">
            <fileset dir="framework/dist-${j2ee.api}/doc/api"/>
        </copy>

    </target>

    <target name="package"
        depends="package.anttasks,package.framework,package.sample-servlet,package.documentation">
    </target>

    <!--
       ========================================================================
          Make the distribution.
       ========================================================================
     -->
    <target name="dist" depends="run,package">
    </target>

   <!--
       ========================================================================
         Clean generated files (including distributables)
       ========================================================================
    -->
    <target name="clean.anttasks" depends="init">

        <ant target="clean" antfile="anttasks/build.xml"
            inheritAll="false">

            <property file="build.properties" />
            <property file="${user.home}/build.properties" />

        </ant>

    </target>

    <target name="clean.framework" depends="init">

        <ant target="clean" antfile="framework/build.xml"
            inheritAll="false">

            <!-- j2ee.jar property is needed here as it is overriden in the
                 build-admin.xml and we need to propagate it -->
            <property name="j2ee.jar" value="${j2ee.jar}"/>
            <property file="build.properties" />
            <property file="${user.home}/build.properties" />

        </ant>

    </target>

    <target name="clean.sample-servlet" depends="clean.anttasks,clean.framework">

        <ant target="clean" antfile="sample-servlet/build.xml"
            inheritAll="false">

            <!-- j2ee.jar property is needed here as it is overriden in the
                 build-admin.xml and we need to propagate it -->
            <property name="j2ee.jar" value="${j2ee.jar}"/>
            <property file="build.properties" />
            <property file="${user.home}/build.properties" />

        </ant>

    </target>

    <target name="clean.documentation" depends="clean.anttasks">

        <ant target="clean" antfile="documentation/build.xml"
            inheritAll="false">

            <property file="build.properties" />
            <property file="${user.home}/build.properties" />

        </ant>

    </target>

    <target name="clean.cactus" depends="init">

        <delete dir="${target.dir}"/>
        <delete dir="${dist.dir}"/>

    </target>

    <target name="clean"
        depends="clean.cactus,clean.anttasks,clean.framework,clean.sample-servlet,clean.documentation"
        description="Clean all generated files">
    </target>

    <!--
       ========================================================================
         Clean all, for all J2EE APIs
       ========================================================================
    -->
    <target name="clean.all"
        description="Clean all generated files (for all J2EE APIs)">

        <echo message="j2ee.12.jar = ${j2ee.12.jar}"/>
        <echo message="j2ee.13.jar = ${j2ee.13.jar}"/>

        <ant target="clean" inheritAll="false">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/>
        </ant>

        <ant target="clean" inheritAll="false">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/>
        </ant>

    </target>

    <!--
       ========================================================================
         Common script for both "release" and "gump" targets. Must only be
         called by "release" or "gump" target as it needs the following
         properties defined before calling it :

             cactus.release.name

       ========================================================================
    -->
    <target name="release.common" depends="init">

        <mkdir dir="${target.lib.dir}"/>
        <mkdir dir="${release.dir}"/>

        <!-- Copy external libraries in a tmp directory for them to be included
             in the distribution -->
        <copy todir="${target.lib.dir}" file="${log4j.jar}"/>
        <copy todir="${target.lib.dir}" file="${commons.logging.jar}"/>
        <copy todir="${target.lib.dir}" file="${commons.httpclient.jar}"/>
        <copy todir="${target.lib.dir}" file="${httpunit.jar}"/>
        <copy todir="${target.lib.dir}" file="${junit.jar}"/>
        <copy todir="${target.lib.dir}" file="${aspectjrt.jar}"/>
        <copy todir="${target.lib.dir}" file="${servlet.jar}"/>
        <copy todir="${target.lib.dir}" file="${jstl.jar}"/>
        <copy todir="${target.lib.dir}" file="${standard.jar}"/>

        <zip zipfile="${release.dir}/${cactus.release.name}.zip">

            <zipfileset dir="${dist.dir}" prefix="${cactus.release.name}"/>

            <!-- Add the external libraries to the zip (except the j2ee.jar one
                 as it is already present in containers -->
            <zipfileset dir="${target.lib.dir}" prefix="${cactus.release.name}/lib">
                <include name="*.jar"/>
            </zipfileset>

            <!-- Add the licenses -->
            <zipfileset dir="." prefix="${cactus.release.name}">
                <include name="LICENSE.*"/>
            </zipfileset>
        </zip>

    </target>

    <!--
       ========================================================================
         Generate a full release (i.e. the zipped release file)
       ========================================================================
    -->
    <target name="release.prepare" depends="init">

        <!-- For a release, the suffix is the version -->
        <property name="project.suffix" value="-${project.version}"/>

        <!-- Name of full release -->
        <property name="cactus.release.name"
            value="${project.prefix}${project.name.file}-${j2ee.api}${project.suffix}"/>

    </target>

    <target name="release" depends="release.prepare,clean,dist,release.common"
        description="Generate a release">
    </target>

    <!--
       ========================================================================
         Generate a nightly gump release (i.e. the zipped release file).
         Note: Our Gump scripts builds all sub projects separately (see
         gump.xml) and thus we only need to package the distribution but there
         is no need to actually run the dependent projects as they have already
         been run by Gump at this stage.
       ========================================================================
    -->
    <target name="gump.prepare" depends="init">

        <!-- Sets the date for the release prefix : YYYYMMDD -->
        <tstamp/>

        <!-- Suffix to add to all distributable files -->
        <property name="project.suffix" value="-${DSTAMP}"/>

        <!-- Name of nightly release -->
        <property name="cactus.release.name"
            value="${project.prefix}${project.name.file}-${j2ee.api}${project.suffix}"/>

    </target>

    <target name="gump" depends="gump.prepare,package,release.common"
        description="Generate a nightly gump release">
    </target>

    <!--
       ========================================================================
         Common target for both "release.src" and "gump.src".
       ========================================================================
    -->
    <target name="release.src.common" depends="init">

        <mkdir dir="${release.dir}"/>

        <zip zipfile="${release.dir}/${cactus.release.src.name}.zip">

            <zipfileset dir="." prefix="${cactus.release.src.name}">
                <exclude name="**/target*/**"/>
                <exclude name="**/dist*/**"/>
                <exclude name="**/release/**"/>
                <exclude name="**/misc/**"/>
                <exclude name="**/*.log"/>
                <exclude name="**/build.properties"/>
                <exclude name="**/ant.bat"/>
                <exclude name="**/.*"/>
            </zipfileset>

        </zip>

    </target>

    <!--
       ========================================================================
         Generate the source distributable.
       ========================================================================
    -->
    <target name="release.src.prepare" depends="init">

        <!-- For a release, the suffix is the version -->
        <property name="project.suffix" value="-${project.version}"/>

        <!-- Name of full src release -->
        <property name="cactus.release.src.name"
            value="${project.prefix}${project.name.file}-src${project.suffix}"/>

    </target>

    <target name="release.src" depends="release.src.prepare,release.src.common"
        description="Generate release sources">
    </target>

    <!--
       ========================================================================
         Generate the source nightly build distributable.
       ========================================================================
    -->
    <target name="gump.src.prepare" depends="init">

        <!-- Sets the date for the release prefix : YYYYMMDD -->
        <tstamp/>

        <!-- Suffix to add to all distributable files -->
        <property name="project.suffix" value="-${DSTAMP}"/>

        <!-- Name of nightly src release -->
        <property name="cactus.release.src.name"
            value="${project.prefix}${project.name.file}-src${project.suffix}"/>

    </target>

    <target name="gump.src" depends="gump.src.prepare,release.src.common"
        description="Generate nightly gump sources">
    </target>

</project>