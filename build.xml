<?xml version="1.0"?>
<!DOCTYPE project [
    <!ENTITY common SYSTEM "file:./build-common.xml">
]>

<!--
  =============================================================================
    Master build file for building all Cactus components (the Ant tasks,
    the framework itself, the Integrations, the documentation, the samples, 
    etc).

    See build.properties.sample for details of mandatory and optional
    properties to set.

    This script should be started with the following command line :

        ant <target>

    Run "ant -projecthelp" to get a list of available targets.
  =============================================================================
-->
<project name="Master Cactus Build" default="release" basedir=".">

    <!-- Base directory for all file related operations -->
    <property name="base.dir" location="."/>

    <!-- Give user a chance to override without editing this file
         (and without typing -D each time it compiles it) -->
    <property file="${basedir}/build.properties" />
    <property file="${user.home}/build.properties" />

    <!-- Include properties and targets common to the different subprojects -->
    &common;

    <!-- Global project properties -->
    <property name="project.name.text" value="Cactus"/>
    <property name="project.name.file" value="cactus"/>

    <!--
       ========================================================================
         Generate the release files for all the Cactus subprojects
       ========================================================================
    -->
    <target name="dist">

        <ant antfile="anttasks/build.xml" inheritAll="false" 
            target="dist"/>

        <ant antfile="framework/build.xml" inheritAll="false" 
            target="dist">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/> 
            <property name="clover.enable" value="true"/> 
        </ant>

        <ant antfile="framework/build.xml" inheritAll="false" 
            target="dist">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
            <property name="clover.enable" value="true"/> 
        </ant>

        <ant antfile="integration/ant/build.xml" inheritAll="false" 
            target="dist">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/> 
            <property name="clover.enable" value="true"/> 
        </ant>

        <ant antfile="integration/ant/build.xml" inheritAll="false" 
            target="dist">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
            <property name="clover.enable" value="true"/> 
        </ant>

        <ant antfile="integration/eclipse/org.apache.cactus.eclipse.webapp/build.xml" 
            inheritAll="false" target="dist">
        </ant>
            
        <ant antfile="integration/eclipse/org.apache.cactus.eclipse.runner/build.xml" 
            inheritAll="false" target="dist">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/> 
        </ant>

        <ant antfile="integration/eclipse/org.apache.cactus.eclipse.runner/build.xml" 
            inheritAll="false" target="dist">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
        </ant>

        <ant antfile="samples/servlet/build.xml" inheritAll="false" 
            target="dist">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/> 
            <property name="clover.enable" value="true"/> 
        </ant>

        <ant antfile="samples/servlet/build.xml" inheritAll="false" 
            target="dist">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
            <property name="clover.enable" value="true"/> 
        </ant>
        
        <ant antfile="samples/jetty/build.xml" inheritAll="false" 
            target="dist">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
            <property name="clover.enable" value="true"/> 
        </ant>
        
        <ant antfile="documentation/build.xml" inheritAll="false" 
            target="dist">
            <property name="javadoc.include" value="true"/>
            <property name="clover.enable" value="true"/> 
        </ant>

    </target>

    <!--
       ========================================================================
         Generate the release files for all the Cactus subprojects
       ========================================================================
    -->
    <target name="release"
        depends="clean, dist">
        <antcall target="release.bin" inheritall="no">
            <param name="j2ee.dependant" value="true"/>
            <param name="j2ee.jar" location="${j2ee.12.jar}"/>
            <param name="release.dir" location="release"/>
        </antcall>
        <antcall target="release.bin" inheritall="no">
            <param name="j2ee.dependant" value="true"/>
            <param name="j2ee.jar" location="${j2ee.13.jar}"/>
            <param name="release.dir" location="release"/>
        </antcall>
        <antcall target="release.src"/>
    </target>

    <target name="release.prepare"
        depends="init.properties">
        <mkdir dir="${release.dir}"/>
    </target>

    <target name="release.bin"
        depends="init.properties, release.prepare">
        <zip destfile="${release.dir}/${main.release.name}.zip">
            <zipfileset dir="documentation/dist/doc"
                prefix="${main.release.name}/doc"/>
            <zipfileset file="${aspectjrt.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset file="${cactus.antintegration.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset file="${cactus.framework.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset file="${commons.logging.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset file="${commons.httpclient.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset file="${httpunit.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset file="${junit.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset file="${nekohtml.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset file="${j2ee.jar}"
                prefix="${main.release.name}/lib"/>
            <zipfileset dir="samples/servlet/target-${j2ee.api}/sample"
                prefix="${main.release.name}/samples/servlet">
                <exclude name="lib/**"/>
            </zipfileset>
            <zipfileset file="${jstl.jar}"
                prefix="${main.release.name}/samples/servlet/lib"/>
            <zipfileset file="${standard.jar}"
                prefix="${main.release.name}/samples/servlet/lib"/>
            <zipfileset dir="framework/web"
                prefix="${main.release.name}/web"/>
            <zipfileset dir="." prefix="${main.release.name}"
                includes="LICENSE.*"/>
        </zip>
    </target>

    <target name="release.src"
        depends="init.properties">
        <zip zipfile="${release.dir}/${main.release.name}-src.zip">
            <zipfileset dir="." prefix="${main.release.name}-src">
                <exclude name="**/target*/**"/>
                <exclude name="**/dist*/**"/>
                <exclude name="**/release/**"/>
                <exclude name="**/*.log"/>
                <exclude name="**/build.properties"/>
                <exclude name="**/.*/**"/>
                <exclude name="integration/eclipse/**"/>
                <exclude name="**/*.jar"/>
                <exclude name="**/*.zip"/>
            </zipfileset>
        </zip>
    </target>

    <!--
       ========================================================================
         Clean all generated files by all Cactus subprojects.
       ========================================================================
    -->
    <target name="clean"
        depends="init.properties">

        <delete dir="${release.dir}"/>
        <delete dir="target-12"/>
        <delete dir="target-13"/>
        <delete>
            <fileset dir="." includes="**/*.log"/>
        </delete>

        <ant antfile="anttasks/build.xml" inheritAll="false" 
            target="clean"/>

        <ant antfile="framework/build.xml" inheritAll="false" 
            target="clean">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/> 
        </ant>

        <ant antfile="framework/build.xml" inheritAll="false" 
            target="clean">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
        </ant>

        <ant antfile="integration/ant/build.xml" inheritAll="false" 
            target="clean">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/> 
        </ant>

        <ant antfile="integration/ant/build.xml" inheritAll="false" 
            target="clean">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
        </ant>

        <ant antfile="integration/eclipse/org.apache.cactus.eclipse.webapp/build.xml" 
            inheritAll="false" target="clean">
        </ant>
                
        <ant antfile="integration/eclipse/org.apache.cactus.eclipse.runner/build.xml" 
            inheritAll="false" target="clean">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/> 
        </ant>

        <ant antfile="integration/eclipse/org.apache.cactus.eclipse.runner/build.xml" 
            inheritAll="false" target="clean">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
        </ant>
        
        <ant antfile="samples/servlet/build.xml" inheritAll="false" 
            target="clean">
            <property name="j2ee.jar" value="${j2ee.12.jar}"/> 
        </ant>

        <ant antfile="samples/servlet/build.xml" inheritAll="false" 
            target="clean">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
        </ant>
        
        <ant antfile="samples/jetty/build.xml" inheritAll="false" 
            target="clean">
            <property name="j2ee.jar" value="${j2ee.13.jar}"/> 
        </ant>
        
        <ant antfile="documentation/build.xml" inheritAll="false" 
            target="clean"/>

    </target>

</project>
