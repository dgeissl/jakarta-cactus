<?xml version="1.0"?>

<!--
 * ========================================================================
 * 
 * Copyright 2001-2004 The Apache Software Foundation.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *   http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * 
 * ========================================================================
-->

<document id="task_runservertests">

  <properties>
    <title>RunServerTests Ant Task</title>
  </properties>

  <body>

  <section title="RunServerTests Task">

    <p>
      The <strong>runservertests</strong> task provides support for starting up
      a servlet container to run in-container tests, and shutting it down again
      after the tests have completed.
    </p>
    <p>
      This task will perform several actions, in the following order:
    </p>
    <ul>
      <li>
        Check if a server is already started by constantly trying to
        call the test URL defined by the <code>testurl</code> attribute.
      </li>
      <li>
        If a server is not running, call the Ant target defined by the
        <code>starttarget</code> attribute. This target is supposed to start 
        your container. The <strong>runservertests</strong> task will then
        constantly poll the server by calling the test URL until the server
        answers back.
      </li>
      <li>
        It will then call the Ant target defined by the <code>testtarget</code>
        attribute. This target is supposed to run the unit tests. This is
        usually implemented by using the Ant <code>junit</code> task.
      </li>
      <li>
        Once the tests are finished (i.e. when the
        <code>testtarget</code> has finished executing), it will then
        call the Ant target defined by the <code>stoptarget</code> attribute.
        This target is supposed to stop the container. The
        <strong>runservertests</strong> task will then constantly poll the
        server by calling the test URL until the server stops answering, at
        which point it will consider the server to be stopped. Note that the
        <code>stoptarget</code> will only get called if the server was not
        already started when the <strong>runservertests</strong> task began
        executing. This is to allow keeping running servers for intensive
        debugging phases.
      </li>
    </ul>
    <p>
      The <strong>runservertests</strong> task is generic in the sense that you
      are free to define the <code>starttarget</code>, <code>testtarget</code>
      and <code>stoptarget</code> as you wish and they will get called at the
      right time.
    </p>

    <note>
      Since Ant 1.5, the effects of this task can also be achieved by using a
      combination of the built-in Ant tasks <code>waitfor</code> (with the 
      <code>http</code> condition), <code>parallel</code>, 
      <code>sequential</code> and <code>antcall</code>.
    </note>

    <section title="Parameters">

      <table>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Required</th>
        </tr>
        <tr>
          <td>testurl</td>
          <td>
            The HTTP URL to check whether the server is running.
          </td>
          <td>Yes</td>
        </tr>
        <tr>
          <td>starttarget</td>
          <td>
            The target that is called when the server needs to be started.
          </td>
          <td>Yes</td>
        </tr>
        <tr>
          <td>stoptarget</td>
          <td>
            The target that is called when the server should be shut down.
          </td>
          <td>Yes</td>
        </tr>
        <tr>
          <td>testtarget</td>
          <td>
            The target that is called once the server is running. This target
            will normally perform the actual unit tests.
          </td>
          <td>Yes</td>
        </tr>
        <tr>
          <td>timeout</td>
          <td>
            The timeout in seconds. If the server could not be started before
            the timeout is reached, the task will terminate and report a
            failure.
          </td>
          <td>No</td>
        </tr>
      </table>

    </section>

    <section title="Examples">

      <p>
        In the following example, the target <code>start.tomcat.40</code> will
        be called if the specified test URL is not available. After the server
        has started up so that requests to the test URL return successful HTTP
        status codes, the target <code>test</code> is called. Finally, after the
        <code>test</code> target has completed, the target
        <code>stop.tomcat.40</code> is called to shut down the servlet
        container.
      </p>

      <source><![CDATA[
<runservertests
    testurl="http://localhost:${test.port}/test/ServletRedirector?Cactus_Service=RUN_TEST"
    starttarget="start.tomcat.40"
    stoptarget="stop.tomcat.40"
    testtarget="test"/>
]]></source>
   <p>
     If we use Cargo to start and stop the container, the first and third targets
     can be:
    
    <source><![CDATA[
<target name="start.tomcat.40">
  <mkdir dir="${target.dir}/tomcat4x"/>
  <mkdir dir="${target.dir}/tomcat4x/config"/>
  <cargo id="tomcat4x" containerId="tomcat4x" action="start"
      homeDir="/home/shared/g_ciamassvr/j2ee/jakarta-tomcat-4.1.31"
      log="${target.dir}/tomcat4x/cargo_start.log"
      output="${target.dir}/tomcat4x/container_start.log">
    <configuration dir="${target.dir}/tomcat4x/config">
      <property name="cargo.servlet.port" value="${cactus.port}"/>
      <property name="cargo.servlet.users" value="${cactus.securitytest.users}"/>
      <property name="cargo.logging" value="high"/>
      <war warfile="${target.dir}/${project.name.file}-cactified.war"/>
    </configuration>
    <!-- Configure Cactus for logging -->
    <syspropertyset file="${target.dir.normalized}/logging_server.properties"/>
  </cargo>
</target>
<target name="stop.tomcat.40">
  <cargo refid="tomcat4x" action="stop"
      log="${target.dir}/tomcat4x/cargo_stop.log"
      output="${target.dir}/tomcat4x/container_stop.log"/>
</target>
]]></source>
   </p>
    In particular, CactusTests can be used for the test target as following:
   <p>

<source><![CDATA[
 <target name="run-testcases">  
   <mkdir dir="${target.testreports.dir}"/>
   <mkdir dir="${target.testreports.dir}/tomcat4x"/>
   <cactustests fork="yes" failureproperty="tests.failed" haltonerror="true" 
       servletport="${cactus.port}"
       warfile="${target.dir}/${project.name.file}-cactified.war" 
       todir="${target.testreports.dir}/tomcat4x" 
       logs="${target.dir.normalized}/logging_client.properties">
      <classpath>
          <path refid="project.classpath"/>
          <path refid="cactus.classpath"/>
          <pathelement location="${httpunit.jar}"/>
          <pathelement location="${nekohtml.jar}"/>
          <pathelement location="${target.classes.java.dir}"/>
          <pathelement location="${target.classes.cactus.dir}"/>
          <pathelement location="${log4j.jar}"/>
      </classpath>
      <formatter type="xml"/>
      <batchtest>
        <fileset dir="${src.cactus.dir}">
          <include name="**/servlet/unit/Test*.java"/>
          <exclude name="**/servlet/unit/Test*All.java"/>
        </fileset>
      </batchtest>
    </cactustests>
  </target>
]]></source>
   </p>
    </section>

  </section>

  </body>
</document>
